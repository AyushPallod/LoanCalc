<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loan Calculator</title>
  </head>
  <body>
    <div id="root"></div>

    <!-- React + Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Date library -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/dist/date-fns.min.js"></script>

    <!-- App Code -->
    <script type="text/babel">

      const { useState } = React;
      const { addDays, differenceInDays, format } = dateFns;

      function LoanCalculator() {
        const [principal, setPrincipal] = useState('');
        const [rate, setRate] = useState('');
        const [openDate, setOpenDate] = useState('');
        const [closeDate, setCloseDate] = useState('');
        const [deposits, setDeposits] = useState([]);
        const [results, setResults] = useState([]);

        const handleDepositAdd = () => setDeposits([...deposits, { date: '', amount: '' }]);

        const handleDepositChange = (i, field, val) => {
          const arr = [...deposits];
          arr[i][field] = val;
          setDeposits(arr);
        };

        const calculate = () => {
          if (!principal || !rate || !openDate) return;
          let start = new Date(openDate);
          let end = closeDate ? new Date(closeDate) : new Date();
          const totalDays = differenceInDays(end, start);
          const intervals = Math.floor(totalDays / 30);
          let p = parseFloat(principal);
          const r = parseFloat(rate) / 100 / 365;
          const rows = [];

          for (let i = 0; i < intervals; i++) {
            const monthStart = addDays(start, i * 30);
            const monthEnd = addDays(start, (i + 1) * 30);
            const monthDeposits = deposits.filter(dep => dep.date && new Date(dep.date) > monthStart && new Date(dep.date) <= monthEnd);

            if (monthDeposits.length === 0) {
              const interest = p * r * 30;
              p += interest;
              rows.push({ date: format(monthEnd, 'yyyy-MM-dd'), interest: interest.toFixed(2), total: p.toFixed(2) });
            } else {
              let currentPrincipal = p;
              let lastDate = monthStart;
              monthDeposits.forEach(dep => {
                const depDate = new Date(dep.date);
                const daysBefore = differenceInDays(depDate, lastDate);
                const interestBefore = currentPrincipal * r * daysBefore;
                currentPrincipal += interestBefore;
                rows.push({ date: format(depDate, 'yyyy-MM-dd'), interest: interestBefore.toFixed(2), total: currentPrincipal.toFixed(2) });
                currentPrincipal -= parseFloat(dep.amount || 0); // deposit reduces principal
                lastDate = depDate;
              });
              const daysAfter = differenceInDays(monthEnd, lastDate);
              const interestAfter = currentPrincipal * r * daysAfter;
              currentPrincipal += interestAfter;
              rows.push({ date: format(monthEnd, 'yyyy-MM-dd'), interest: interestAfter.toFixed(2), total: currentPrincipal.toFixed(2) });
              p = currentPrincipal;
            }
          }

          const lastInterestDate = addDays(start, intervals * 30);
          const remainingDays = differenceInDays(end, lastInterestDate);
          if (remainingDays > 0) {
            const interest = p * r * remainingDays;
            p += interest;
            rows.push({ date: format(end, 'yyyy-MM-dd'), interest: interest.toFixed(2), total: p.toFixed(2) });
          }
          setResults(rows);
        };

        return (
          <div style={{ maxWidth: '700px', margin: '40px auto', fontFamily: 'sans-serif' }}>
            <h2>Loan Calculator</h2>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
              <input placeholder=\"Principal Amount\" type=\"number\" value={principal} onChange={e => setPrincipal(e.target.value)} />
              <input placeholder=\"Rate of Interest (annual %)\" type=\"number\" value={rate} onChange={e => setRate(e.target.value)} />
              <input placeholder=\"Opening Date\" type=\"date\" value={openDate} onChange={e => setOpenDate(e.target.value)} />
              <input placeholder=\"Closing Date (optional)\" type=\"date\" value={closeDate} onChange={e => setCloseDate(e.target.value)} />
            </div>

            <h4 style={{ marginTop: '20px' }}>Deposits</h4>
            {deposits.map((dep, i) => (
              <div key={i} style={{ display: 'flex', gap: '10px', marginBottom: '5px' }}>
                <input type=\"date\" value={dep.date} onChange={e => handleDepositChange(i, 'date', e.target.value)} />
                <input type=\"number\" placeholder=\"Amount\" value={dep.amount} onChange={e => handleDepositChange(i, 'amount', e.target.value)} />
              </div>
            ))}
            <button onClick={handleDepositAdd}>Add Deposit</button>
            <br /><br />
            <button onClick={calculate} style={{ width: '100%', padding: '10px', background: 'black', color: 'white' }}>Calculate</button>

            {results.length > 0 && (
              <table border=\"1\" cellPadding=\"5\" style={{ width: '100%', marginTop: '20px', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ background: '#f2f2f2' }}>
                    <th>Date</th>
                    <th>Interest</th>
                    <th>Total Amount</th>
                  </tr>
                </thead>
                <tbody>
                  {results.map((r, i) => (
                    <tr key={i}>
                      <td>{r.date}</td>
                      <td>{r.interest}</td>
                      <td>{r.total}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<LoanCalculator />);
    </script>
  </body>
</html>
